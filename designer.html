<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Designer</title>
  <meta name="description" 
          content="Designer Drawing Block.">
  <link rel="stylesheet" href="{{ static_url("style.css") }}">
  <link rel="stylesheet" href="{{ static_url("jquery-ui.min.css") }}">
  <!--[if IE]>
  <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
</head>

<body>
<div id="page_info">Designer Block. Generated by BORA 0.0.1</div>
<img src="{{ static_url('background.png') }}"></img>    

<button class="button showhide" onclick="showhide()">Show/Hide</button>

{% if data['style'] %}
{% for key in data['style'] %}
{% if data['style'][key]['type'] == "data" %}
<div style='position: absolute; top: {{ data['style'][key]['top'] }}; left:{{
    data['style'][key]['left'] }}; width:{{ data['style'][key]['width'] }}px;
    height:{{ data['style'][key]['height'] }}px;' 
{% if "condition" in data['style'][key] %}
 data-cond="{{ data['style'][key]['condition'] }}"
{% else%}
{% end%}
{% if "formula" in data['style'][key] %}
 data-formula="{{ data['style'][key]['formula'] }}"
{% else %}
{% end %}
{% if "lesser" in data['style'][key] %}
 data-lesser="{{ data['style'][key]['lesser'] }}"
{% else %}
{% end %}
{% if "larger" in data['style'][key] %}
 data-larger="{{ data['style'][key]['larger'] }}"
{% else %}
{% end %}
 data-type="{{ data['style'][key]['type'] }}" class='varbox' id="{{ key }}">
<p><span style="color: #000; font-size: {{ data['style'][key]['header']['size'] }}; font-weight: {{ data['style'][key]['header']['weight'] }};" class="title">{{ data['style'][key]['header']['title'] }} </span><span style="color: #000; font-size: {{ data['style'][key]['unit']['size'] }}; font-weight: {{ data['style'][key]['unit']['weight'] }};" class="varval"> XXX.XX <span class='unit_title' style="color: #000; font-size: {{ data['style'][key]['unit']['size'] }}; font-weight: {{ data['style'][key]['unit']['weight'] }};" > {{ data['style'][key]['unit']['title'] }}</span></span></p>
</div>
{% else %}
{% end %}


{% if data['style'][key]['type'] == "ventil" %}
<div style='position: absolute; top: {{ data['style'][key]['top'] }}; left:{{ data['style'][key]['left'] }}; width:{{ data['style'][key]['width'] }}px; height:{{ data['style'][key]['height'] }}px;' data-type="{{ data['style'][key]['type'] }}" data-off="{{ data['style'][key]['off'] }}" data-on="{{ data['style'][key]['on'] }}" class='varbox' id="{{ key }}">
<img width='100%' height='100%' src='{{ static_url("ventil_inactive.png") }}'></img>
</div>
{% else %}
{% end %}

{% if data['style'][key]['type'] == "integer-to-string" %}
<div style='position: absolute; top: {{ data['style'][key]['top'] }}; left:{{
    data['style'][key]['left'] }}; width:{{ data['style'][key]['width'] }}px;
    height:{{ data['style'][key]['height'] }}px;' data-cond="{{data['style'][key]['cond']}}"  data-dict="{{ data['style'][key]['dict'] }}" data-type="{{ data['style'][key]['type'] }}" class='varbox' id="{{ key }}">
<p><span style="color: #000; font-size: {{ data['style'][key]['header']['size'] }}; font-weight: {{ data['style'][key]['header']['weight'] }};" class="title">{{ data['style'][key]['header']['title'] }} </span><br /><span style="color: #000; font-size: {{ data['style'][key]['unit']['size'] }}; font-weight: {{ data['style'][key]['unit']['weight'] }};" class="varval">??? </span></p>
</div>
{% else %}
{% end %}

{% if data['style'][key]['type'] == "header" %}
<div style='position: absolute; top: {{ data['style'][key]['top'] }}; left:{{
    data['style'][key]['left'] }}; width:{{ data['style'][key]['width'] }}px;
    height:{{ data['style'][key]['height'] }}px;' data-type="{{ data['style'][key]['type'] }}" class='varbox' id="{{ key }}">
<p><span style="color: #000; font-size: {{ data['style'][key]['header']['size'] }}; font-weight: {{ data['style'][key]['header']['weight'] }};" class="title">{{ data['style'][key]['header']['title'] }} </span></p>
</div>
{% else %}
{% end %}


{% end %}

{% else %}
{% end %}

    
    
<div id="tool-btn">
<span class="info">Variable</span>
<select id="varname" style="font-size:16pt;">
{% if data['cache'] %}  
  {% for key in data['cache'] %}
    {% if key != "time" %}  
    <option value={{data['cache'][key]}}>{{key}}</option>
    {% else %}
    {% end %}
  {% end %}
{% else %}
{% end %}
</select>
<span class="info">Type</span>
<select id="vartype" style="font-size:16pt;">
  <option value="data">data</option>
  <option value="ventil">ventil</option>
  <option value="integer-to-string">integer-to-string</option>
  <option value="header">header</option>
</select>
<br /><br />
<span class="info">Title</span>
<input type="text" id="elem_title_text" placeholder="text" style="font-size:16pt; width=100px;"/>
<input type="text" id="elem_title_size" placeholder="size" style="font-size:16pt; width=100px;"/>

<input type="text" id="elem_lesser_range" placeholder="smaller than (red)" style="font-size:16pt; width=100px;"/>
<input type="text" id="elem_larger_range" placeholder="larger than (red)" style="font-size:16pt; width=100px;"/>

<select id="elem_title_style" style="font-size:16pt;">
  <option value="400">normal</option>
  <option value="700">bold</option>
</select>
<br /><br />
<span class="info">Value</span>
<input type="text" id="elem_unit_text" placeholder="unit" style="font-size:16pt; width=100px;"/>
<input type="text" id="elem_unit_size" placeholder="size" style="font-size:16pt; width=100px;"/>

<input type="text" id="elem_condition_range" placeholder="condition (red)" style="font-size:16pt; width=100px;"/>
<input type="text" id="elem_formula" placeholder="Equation" style="font-size:16pt; width=100px;"/>

<select id="elem_unit_style" style="font-size:16pt;">
  <option value="400">normal</option>
  <option value="700">bold</option>
</select>
<br /><br />
<button class="button save" onclick="backup()">Backup</button>
<button style="display:none;" id="buttonHighlight" class="button highlight" onclick="highlight({{ data['cache'] }})">Highlight</button>
<button class="button add" onclick="add()">Add</button>
<button class="button remove" onclick="myremove()">Remove</button>
<button class="button save" onclick="mysave({{ data['cache'] }})">Save</button>

</div>

    
<!-- java script -->
<script src="{{ static_url("jquery-1.12.3.min.js") }}"></script>
<script src="{{ static_url("jquery-ui.min.js") }}"></script>
<script>
function backup() {
    $.ajax({
        url: '/backup/',
        type: 'POST',
        success: function (response) {
            alert("Backup success!");
        },
        error: function () {
            console.log("Error.")
        }
    });
}    
    
function showhide() {
    console.log("Show or Hide");
    $("#tool-btn").toggle();
}
    
function add() {
    console.log("add element");
    title_text = $("#elem_title_text").val();
    title_text = title_text.trim();
    title_color = "#000000";
    //title_color = $("#elem_title_color").val();
    title_size = $("#elem_title_size").val();
    title_style = $("#elem_title_style option:selected").val();
    
    unit_text = $("#elem_unit_text").val();
    unit_text = unit_text.trim();
    unit_color = "#000";
    //unit_color = $("#elem_unit_color").val();
    unit_size = $("#elem_unit_size").val();
    unit_style = $("#elem_unit_style option:selected").val();
    
    data_condition = $("#elem_condition_range").val();
    //data_max = $("#elem_max_range").val();
    
    data_formula = $("#elem_formula").val();
    
    data_lesser = $("#elem_lesser_range").val();
    data_larger = $("#elem_larger_range").val();
    
    varval = $( "#varname option:selected").val();
    varname = $("#varname option:selected").text();
    vartype = $("#vartype option:selected").val();
    console.log("Selected");
    console.log(vartype);

    console.log(title_text, unit_text, varname, varval, vartype);
    
        
    if(($("#" + varname).length == 0) || (vartype=="header")) {
        console.log("Must enter here");
        console.log(vartype);
        if (vartype == "data") {
            console.log("Data");
            html_text = "<div " +
                    "style='position: absolute; " +
                           "top:0; " +
                           "left:0;' " +
                    "class='varbox box_highlight' " + 
                    "id='" + varname +
                    "' data-type='" + vartype +
                    "' data-cond='" + data_condition +
                    "' data-formula='" + data_formula +
                    "' data-lesser='" + data_lesser + 
 		    "' data-larger='" + data_larger + 
                    "'>" +
                    "<p>" +
                    "<span style='color: " + title_color + ";" + 
                    "font-size:" + title_size + "px; " + 
                    "font-weight: " + title_style + ";' " + 
                    "class='title'>" + title_text +
                    " </span>" + 
                    "<span style='color: " + unit_color + "; " + 
                           "font-size:" + unit_size + "px; " +
                           "font-weight: " + unit_style + ";' " + 
                    "class='varval'>" + parseFloat(varval).toFixed(2) + " </span>" + 
                    "<span class='unit_title'>" + unit_text + "</span></p>" +
        	    "</div>";
        } else if (vartype == "header") {
            console.log("Header");
            varname = "header_" + title_text.replace(/\s+/g, '-').toLowerCase();
            html_text = "<div " +
                    "style='position: absolute; " +
                           "top:0; " +
                           "left:0;' " +
                    "class='varbox box_highlight' " + 
                    "id='" + varname +
                    "' data-type='" + vartype +
                    "' data-cond='" + data_condition +
                    "' data-lesser='" + data_lesser + 
 		            "' data-larger='" + data_larger + 
                    "'>" +
                    "<p>" +
                    "<span style='color: " + title_color + ";" + 
                    "font-size:" + title_size + "px; " + 
                    "font-weight: " + title_style + ";' " + 
                    "class='title'>" + title_text +
                    " </span></p>" + 
        	    "</div>";
        } else if (vartype == "ventil") {
            console.log("Ventil");
            var token = JSON.parse(unit_text);
            data_on = token["on"];
            data_off = token["off"];

            html_text = "<div " +
                    "style='position: absolute; " +
                           "top:0; " +
                           "left:0;' " +
                    "class='varbox box_highlight' " + 
                    "id='" + varname +
                    "' data-type='" + vartype +
                    "' data-cond='" + data_condition +
                    "' data-lesser='" + data_lesser + 
 		            "' data-larger='" + data_larger + 
 		            "' data-on='" + data_on + 
 		            "' data-off='" + data_off + 
                    "'>" +
 		            "<img width='100%' height='100%' " + 
                    "src='{{ static_url("ventil_inactive.png") }}'></img>" +
        	        "</div>";	    
	    } else if (vartype == "integer-to-string") {
            console.log("Integer2String");
            html_text = "<div " +
                    "style='position: absolute; " +
                           "top:0; " +
                           "left:0;' " +
                    "class='varbox box_highlight' " + 
                    "id='" + varname +
                    "' data-type='" + vartype +
                    "' data-dict='" + unit_text +
                    "' data-cond='" + data_condition +
                    "'>" +
                    "<p>" +
                    "<span style='color: " + title_color + ";" + 
                    "font-size:" + title_size + "px; " + 
                    "font-weight: " + title_style + ";' " + 
                    "class='title'>" + title_text +
                    " </span><br />" + 
                    "<span style='color: " + unit_color + "; " + 
                           "font-size:" + unit_size + "px; " +
                           "font-weight: " + unit_style + ";' " + 
                    "class='varval'>??? </span>" + 
                    "</p>" +
        	        "</div>";
        }
        console.log("Adding element");
        console.log(html_text);
        $( "body" ).append(html_text);
        $("#"+varname).draggable();
        $("#"+varname).resizable(); 
    }
} 
function myremove() {
    varname = $("#varname option:selected").text();
    vartype = $("#vartype option:selected").val();
    if (vartype != "header") {
        if($("#" + varname).length > 0) {
            $("#"+varname).remove();
            console.log(varname +" removed.");
        }
    } else {
        title_text = $("#elem_title_text").val();
        title_text = title_text.trim();
        varname = "header_" + title_text.replace(/\s+/g, '-').toLowerCase();
        $("#"+varname).remove();
        console.log(varname +" removed.");
    }
}

function mysave(data) {
    console.log("saving...");
    console.log(data);
    var position = {};
    for(key in data) {
        var tmp = {};
        console.log(key);
        if($("#" + key).length > 0 ) {
            
            tmp["left"] = $("#"+key).css("left");
            tmp["top"] = $("#"+key).css("top");
            tmp["width"] = $("#"+key).width();
            tmp["height"] = $("#"+key).height();
            tmp["type"] = $("#"+key).attr("data-type");

            if ( $("#"+key).attr("data-type") == "data" ) {
            	tmp["condition"] = $("#"+key).attr("data-cond");
            	tmp["formula"] = $("#"+key).attr("data-formula");
            	tmp["lesser"] = $("#"+key).attr("data-lesser");
            	tmp["larger"] = $("#"+key).attr("data-larger");
            	//tmp["min"] = $("#"+key).attr("min");
           	//tmp["max"] = $("#"+key).attr("max");
            
            	header = {};
            	header["title"] = $(".title", "#"+key).text();
            	//header["color"] = $(".title", "#"+key).css("color");
            	header["size"] = $(".title", "#"+key).css("font-size");
            	header["weight"] = $(".title", "#"+key).css("font-weight");
            
            	unit = {};
            	unit["title"] = $(".unit_title", "#"+key).text();
            	//unit["color"] = $(".varval", "#"+key).css("color");
            	unit["size"] = $(".varval", "#"+key).css("font-size");
            	unit["weight"] = $(".varval", "#"+key).css("font-weight");

            	tmp["header"] = header;
            	tmp["unit"] = unit;
            } else if ( $("#"+key).attr("data-type") == "header" ) {
            	//tmp["condition"] = $("#"+key).attr("data-cond");
            	//tmp["lesser"] = $("#"+key).attr("data-lesser");
            	//tmp["larger"] = $("#"+key).attr("data-larger");
            	//tmp["min"] = $("#"+key).attr("min");
           	    //tmp["max"] = $("#"+key).attr("max");
            	header = {};
            	header["title"] = $(".title", "#"+key).text();
            	//header["color"] = $(".title", "#"+key).css("color");
            	header["size"] = $(".title", "#"+key).css("font-size");
            	header["weight"] = $(".title", "#"+key).css("font-weight");
            
            	//unit = {};
            	//unit["title"] = $(".unit_title", "#"+key).text();
            	//unit["color"] = $(".varval", "#"+key).css("color");
            	//unit["size"] = $(".varval", "#"+key).css("font-size");
            	//unit["weight"] = $(".varval", "#"+key).css("font-weight");

            	tmp["header"] = header;
            	//tmp["unit"] = unit;
            } else if ( $("#"+key).attr("data-type") == "ventil" ) {
            	tmp["on"] = $("#"+key).attr("data-on");
            	tmp["off"] = $("#"+key).attr("data-off");
            } else if ( $("#"+key).attr("data-type") == "integer-to-string" ) {
            	tmp["dict"] = $("#"+key).attr("data-dict");
            	tmp["cond"] = $("#"+key).attr("data-cond");
            	header = {};
            	header["title"] = $(".title", "#"+key).text();
            	//header["color"] = $(".title", "#"+key).css("color");
            	header["size"] = $(".title", "#"+key).css("font-size");
            	header["weight"] = $(".title", "#"+key).css("font-weight");
            
            	unit = {};
            	unit["title"] = $(".unit_title", "#"+key).text();
            	//unit["color"] = $(".varval", "#"+key).css("color");
            	unit["size"] = $(".varval", "#"+key).css("font-size");
            	unit["weight"] = $(".varval", "#"+key).css("font-weight");

            	tmp["header"] = header;
            	tmp["unit"] = unit;
            }

            position[key] = tmp;
        }
    }

    $('[id^=header_]').each(function( index ) {
        tmp = {};
        var hkey = $( this ).attr('id');
        tmp["left"] = $("#"+hkey).css("left");
        tmp["top"] = $("#"+hkey).css("top");
        tmp["width"] = $("#"+hkey).width();
        tmp["height"] = $("#"+hkey).height();
        tmp["type"] = $("#"+hkey).attr("data-type");

        //tmp["condition"] = $("#"+hkey).attr("data-cond");
        //tmp["lesser"] = $("#"+hkey).attr("data-lesser");
        //tmp["larger"] = $("#"+hkey).attr("data-larger");
        //tmp["min"] = $("#"+hkey).attr("min");
        //tmp["max"] = $("#"+hkey).attr("max");
        header = {};
        header["title"] = $(".title", "#"+hkey).text();
        //header["color"] = $(".title", "#"+hkey).css("color");
        header["size"] = $(".title", "#"+hkey).css("font-size");
        header["weight"] = $(".title", "#"+hkey).css("font-weight");

        tmp["header"] = header;
        position[hkey] = tmp;
        //console.log( index + ": " + $( this ).text() );
    });

    //console.log("Check here");
    //console.log(position);
    var dataToSend = JSON.stringify(position);
    //console.log(dataToSend);
    $.ajax({
        url: '/save/',
        type: 'POST',
        data: dataToSend,
        success: function (response) {
            var objresponse = JSON.parse(response);
            console.log(objresponse);
        },
        error: function () {
            console.log("Error.")
        }
    });
}
    
function highlight(mydata) {
    varname = $("#varname option:selected").text();
    vartype = $("#"+varname).attr("data-type");
    $("#vartype").val(vartype);
    //console.log(varname, vartype);

    // clear values
    $("#elem_title_text").val("");
    $("#elem_title_size").val("");
    $("#elem_unit_text").val("");
    $("#elem_unit_size").val("");
    $("#elem_lesser_range").val("");
    $("#elem_larger_range").val("");
    $("#elem_condition_range").val("");
    $("#elem_formula").val("");

    if (vartype == "header") {
        title_text = $("#elem_title_text").val();
        title_text = title_text.trim();
        varname = "header_" + title_text.replace(/\s+/g, '-').toLowerCase();
    } else if (vartype == "data") {
        $("#elem_title_text").val($("#"+varname + " .title").text().trim());
        $("#elem_title_size").val("");
        if ($("#"+varname + " .title").css("font-size")) {
            $("#elem_title_size").val(parseFloat($("#"+varname + " .title").css("font-size")));
        }
        $("#elem_unit_text").val($("#"+varname + " .unit_title").text().trim());
        $("#elem_unit_size").val("");
        if ($("#"+varname + " .varval").css("font-size")) {
            $("#elem_unit_size").val(parseFloat($("#"+varname + " .varval").css("font-size")));
        }
        $("#elem_lesser_range").val("");
        if ($("#"+varname).attr("data-lesser") ) {
            $("#elem_lesser_range").val($("#"+varname).attr("data-lesser"));
        }
        $("#elem_larger_range").val("");
        if ($("#"+varname).attr("data-larger") ) {
            $("#elem_larger_range").val($("#"+varname).attr("data-larger"));
        }
        $("#elem_condition_range").val("");
        if ($("#"+varname).attr("data-cond") ) {
            $("#elem_condition_range").val($("#"+varname).attr("data-cond"));
        }
        $("#elem_formula").val("");
        if ($("#"+varname).attr("data-formula") ) {
            $("#elem_formula").val($("#"+varname).attr("data-formula"));
        }
    } else if (vartype == "ventil") {
        $("#elem_unit_text").val("{'on':"+$("#"+varname).attr("data-on") + ",'off':"+$("#"+varname).attr("data-off")+"}" );
    } else if (vartype == "integer-to-string") {
        $("#elem_title_text").val($("#"+varname + " .title").text().trim());
        $("#elem_title_size").val("");
        if ($("#"+varname + " .title").css("font-size")) {
            $("#elem_title_size").val(parseFloat($("#"+varname + " .title").css("font-size")));
        }
        $("#elem_unit_text").val($("#"+varname).attr("data-dict"));
        $("#elem_condition_range").val("");
        if ($("#"+varname).attr("data-cond") ) {
            $("#elem_condition_range").val($("#"+varname).attr("data-cond"));
        }
        
    }

    for(key in mydata) {
        console.log(key, varname);
        if(($("#" + key).length > 0) && (key == varname) ) {
            //if (!$("#"+varname).hasClass("box_highlight")) {
            $("#"+key).addClass("box_highlight");
            //}
        } else {
            $("#"+key).removeClass("box_highlight");
        }
    }
}

jQuery(window).load(function () {
    $("#varname > option").each(function() {
        if ($('#'+this.text).length){
            $('#'+this.text).draggable();
            $('#'+this.text).resizable(); 
        }
        //console.log(this.text + ' ' + this.value);
    });
    $('[id^=header_]').each(function( index ) {
        $(this).draggable();
        $(this).resizable(); 
    });

    $("#buttonHighlight").trigger("click"); 

    $("#varname").change(function() {
        varval = $( "#varname option:selected").val();
        varname = $("#varname option:selected").text();
        console.log(varval, varname);
        $("#buttonHighlight").trigger("click"); 
    });
});
</script>
</body>
</html>
